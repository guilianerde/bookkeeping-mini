## ğŸ“˜ æˆ¿ä¸»è¸¢å‡ºæˆå‘˜åŠŸèƒ½ å‰ç«¯éœ€æ±‚è¯¦è¿°

---

### ä¸€ã€ ç»„ä»¶å±‚çº§ç»“æ„ (Component Hierarchy)

```
GroupPage (src/pages/group/index.tsx)
â”œâ”€â”€ MemberList (æˆå‘˜åˆ—è¡¨åŒºåŸŸ)
â”‚   â”œâ”€â”€ MemberItem (å•ä¸ªæˆå‘˜å¡ç‰‡)
â”‚   â”‚   â”œâ”€â”€ Avatar (å¤´åƒ)
â”‚   â”‚   â”œâ”€â”€ Nickname (æ˜µç§°)
â”‚   â”‚   â”œâ”€â”€ RoleBadge (æˆ¿ä¸»æ ‡è¯†)
â”‚   â”‚   â””â”€â”€ KickButton (è¸¢å‡ºæŒ‰é’® - ä»…æˆ¿ä¸»å¯è§)
â”‚   â””â”€â”€ KickConfirmDialog (è¸¢å‡ºç¡®è®¤å¼¹çª—)
â””â”€â”€ WebSocket Handler (ç›‘å¬æˆå‘˜å˜æ›´å¹¿æ’­)
```

**ç»„ä»¶èŒè´£è¯´æ˜ï¼š**
- **MemberItem**: å±•ç¤ºå•ä¸ªæˆå‘˜ä¿¡æ¯ï¼Œæ ¹æ®å½“å‰ç”¨æˆ·èº«ä»½å†³å®šæ˜¯å¦æ˜¾ç¤º"è¸¢å‡º"æŒ‰é’®
- **KickConfirmDialog**: äºŒæ¬¡ç¡®è®¤å¼¹çª—ï¼Œé˜²æ­¢è¯¯æ“ä½œ
- **WebSocket Handler**: ç›‘å¬ `member_kick` å’Œ `member_leave` äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°æˆå‘˜åˆ—è¡¨

---

### äºŒã€ æ•°æ®æ¨¡å‹ä¸æ¥å£æ˜ å°„ (Data Model)

#### 2.1 å‰ç«¯æ•°æ®æ¨¡å‹ (TypeScript Interface)

```typescript
// æˆå‘˜ä¿¡æ¯
interface GroupMember {
  userId: string
  nickname: string
  avatar: string
  role: 'owner' | 'member'  // æˆ¿ä¸» or æ™®é€šæˆå‘˜
  joinTime: number          // åŠ å…¥æ—¶é—´æˆ³
  status?: 0 | 1            // 0=åœ¨æˆ¿ï¼Œ1=ç¦»å¼€/è¢«è¸¢
  leaveTime?: number        // ç¦»å¼€æ—¶é—´æˆ³
  leaveReason?: 'leave' | 'kick'  // ç¦»å¼€åŸå› 
}

// è¸¢å‡ºæˆå‘˜è¯·æ±‚
interface KickMemberRequest {
  groupId: string
  targetUserId: string
}

// è¸¢å‡ºæˆå‘˜å“åº”
interface KickMemberResponse {
  success: boolean
  message?: string
}

// ç¦»å¼€æˆ¿é—´è¯·æ±‚
interface LeaveGroupRequest {
  groupId: string
}

// WebSocket å¹¿æ’­æ¶ˆæ¯
interface MemberChangeMessage {
  type: 'member_kick' | 'member_leave'
  groupId: string
  userId: string            // è¢«è¸¢å‡º/ç¦»å¼€çš„ç”¨æˆ·ID
  operatorId?: string       // æ“ä½œè€…ID (è¸¢å‡ºæ—¶æœ‰å€¼)
  timestamp: number
}

// ç»“ç®—æ›´æ–°æ¶ˆæ¯
interface SettlementMessage {
  type: 'settlement'
  groupId: string
  settlement: {
    transfers: Array<{
      from: string
      to: string
      amount: number
    }>
    netAmounts: Record<string, number>
  }
  timestamp: number
}
```

#### 2.2 åç«¯æ¥å£å¥‘çº¦

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| è¸¢å‡ºæˆå‘˜ | POST | `/groups/kick/{groupId}/{userId}` | æˆ¿ä¸»è¸¢å‡ºæŒ‡å®šæˆå‘˜ |
| ç¦»å¼€æˆ¿é—´ | POST | `/groups/leave/{groupId}` | æˆå‘˜ä¸»åŠ¨ç¦»å¼€æˆ¿é—´ |
| è·å–æˆå‘˜åˆ—è¡¨ | GET | `/groups/{groupId}/members` | è·å–æˆ¿é—´æ‰€æœ‰æˆå‘˜ |

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```typescript
// è¸¢å‡ºæˆå‘˜
POST /groups/kick/123/user456
Authorization: Bearer {token}

// å“åº”
{
  code: 0,
  data: {
    success: true
  },
  message: "æˆå‘˜å·²ç§»é™¤"
}

// ç¦»å¼€æˆ¿é—´
POST /groups/leave/123
Authorization: Bearer {token}

// å“åº”
{
  code: 0,
  data: {
    success: true
  },
  message: "å·²é€€å‡ºæˆ¿é—´"
}
```

**WebSocket å¹¿æ’­æ ¼å¼ï¼š**
```json
// æˆå‘˜è¢«è¸¢
{
  "type": "member_kick",
  "groupId": "123",
  "userId": "user456",
  "operatorId": "owner123",
  "timestamp": 1738742400000
}

// æˆå‘˜ç¦»å¼€
{
  "type": "member_leave",
  "groupId": "123",
  "userId": "user456",
  "timestamp": 1738742400000
}

// ç»“ç®—æ›´æ–°
{
  "type": "settlement",
  "groupId": "123",
  "settlement": {
    "transfers": [
      {"from": "user1", "to": "user2", "amount": 50}
    ],
    "netAmounts": {
      "user1": -50,
      "user2": 50
    }
  },
  "timestamp": 1738742400000
}
```

#### 2.3 å­—æ®µæ˜ å°„è¡¨

| UI å­—æ®µ | åç«¯å­—æ®µ | æ•°æ®è½¬æ¢ |
|---------|----------|----------|
| æ˜µç§° | nickname | ç›´æ¥æ˜ å°„ |
| å¤´åƒ | avatar | ç›´æ¥æ˜ å°„ |
| è§’è‰²æ ‡è¯† | role | owner â†’ "æˆ¿ä¸»"ï¼Œmember â†’ éšè— |
| åŠ å…¥æ—¶é—´ | joinTime | æ—¶é—´æˆ³ â†’ "MM-DD HH:mm" |
| ç¦»å¼€çŠ¶æ€ | status | 0 â†’ åœ¨æˆ¿ï¼Œ1 â†’ å·²ç¦»å¼€ |

---

### ä¸‰ã€ è¯¦ç»†äº¤äº’æµç¨‹ (Interaction Flow)

#### 3.1 æˆ¿ä¸»è¸¢å‡ºæˆå‘˜æµç¨‹

```
1. æˆ¿ä¸»è¿›å…¥æˆ¿é—´é¡µé¢
   â†“
2. æŸ¥çœ‹æˆå‘˜åˆ—è¡¨ï¼Œæ¯ä¸ªæˆå‘˜å¡ç‰‡å³ä¾§æ˜¾ç¤º"è¸¢å‡º"æŒ‰é’®
   ï¼ˆè‡ªå·±çš„å¡ç‰‡ä¸æ˜¾ç¤ºæŒ‰é’®ï¼‰
   â†“
3. ç‚¹å‡»æŸæˆå‘˜çš„"è¸¢å‡º"æŒ‰é’®
   â†“
4. å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼š
   "ç¡®å®šè¦å°† [æ˜µç§°] ç§»å‡ºæˆ¿é—´å—ï¼Ÿ"
   [å–æ¶ˆ] [ç¡®å®š]
   â†“
5. ç‚¹å‡»"ç¡®å®š"åï¼š
   - æŒ‰é’®æ˜¾ç¤º Loading çŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤ç‚¹å‡»ï¼‰
   - è°ƒç”¨ POST /groups/kick/{groupId}/{userId}
   â†“
6. æ¥å£è¿”å›æˆåŠŸï¼š
   - Toast æç¤ºï¼š"å·²å°† [æ˜µç§°] ç§»å‡ºæˆ¿é—´"
   - ç­‰å¾… WebSocket å¹¿æ’­æ›´æ–°æˆå‘˜åˆ—è¡¨
   â†“
7. æ¥å£è¿”å›å¤±è´¥ï¼š
   - Toast æç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚"ä»…æˆ¿ä¸»å¯æ“ä½œ"ï¼‰
   - æ¢å¤æŒ‰é’®çŠ¶æ€
```

#### 3.2 æˆå‘˜è¢«è¸¢å‡ºåçš„ä½“éªŒ

```
è¢«è¸¢å‡ºçš„æˆå‘˜ï¼š
1. æ”¶åˆ° WebSocket å¹¿æ’­ (type: member_kick, userId åŒ¹é…å½“å‰ç”¨æˆ·)
   â†“
2. ç«‹å³æ–­å¼€ WebSocket è¿æ¥
   â†“
3. å¼¹å‡º Toastï¼š"æ‚¨å·²è¢«ç§»å‡ºæˆ¿é—´"
   â†“
4. æ¸…é™¤è¯¥æˆ¿é—´çš„æœ¬åœ°ç¼“å­˜æ•°æ®ï¼š
   - group_members (æˆå‘˜ç¼“å­˜)
   - group_transactions (æµæ°´ç¼“å­˜)
   - group_sessions (æˆ¿é—´ä¼šè¯)
   â†“
5. è‡ªåŠ¨è·³è½¬åˆ°æˆ¿é—´åˆ—è¡¨é¡µ (/pages/groupList/index)
```

```
å…¶ä»–åœ¨çº¿æˆå‘˜ï¼š
1. æ”¶åˆ° WebSocket å¹¿æ’­ (type: member_kick)
   â†“
2. Toast æç¤ºï¼š"[æ˜µç§°] å·²è¢«ç§»å‡ºæˆ¿é—´"
   â†“
3. ä»æˆå‘˜åˆ—è¡¨ä¸­ç§»é™¤è¯¥æˆå‘˜ï¼ˆæ›´æ–° group_members ç¼“å­˜ï¼‰
   â†“
4. æ”¶åˆ°åç»­çš„ settlement å¹¿æ’­ï¼Œæ›´æ–°ç»“ç®—è§†å›¾
   â†“
5. å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥æˆå‘˜çš„è®°è´¦è®°å½•ï¼Œåˆ·æ–°æµæ°´åˆ—è¡¨
```

#### 3.3 æˆå‘˜ä¸»åŠ¨ç¦»å¼€æµç¨‹

```
1. æˆå‘˜ç‚¹å‡»"é€€å‡ºæˆ¿é—´"æŒ‰é’®
   â†“
2. ç¡®è®¤å¯¹è¯æ¡†ï¼š"ç¡®å®šè¦é€€å‡ºæˆ¿é—´å—ï¼Ÿ"
   [å–æ¶ˆ] [ç¡®å®š]
   â†“
3. ç‚¹å‡»"ç¡®å®š"åï¼š
   - æ˜¾ç¤º Loading çŠ¶æ€
   - è°ƒç”¨ POST /groups/leave/{groupId}
   â†“
4. æ¥å£è¿”å›æˆåŠŸï¼š
   - Toast æç¤ºï¼š"å·²é€€å‡ºæˆ¿é—´"
   - æ–­å¼€ WebSocket è¿æ¥
   - æ¸…é™¤æœ¬åœ°ç¼“å­˜
   - è·³è½¬åˆ°æˆ¿é—´åˆ—è¡¨é¡µ
   â†“
5. WebSocket å¹¿æ’­ (type: member_leave) é€šçŸ¥å…¶ä»–æˆå‘˜ï¼š
   - Toast æç¤ºï¼š"[æ˜µç§°] å·²ç¦»å¼€æˆ¿é—´"
   - æ›´æ–°æˆå‘˜åˆ—è¡¨
   - æ›´æ–°ç»“ç®—è§†å›¾
```

#### 3.4 æˆ¿ä¸»ç¦»å¼€æˆ¿é—´çš„ç‰¹æ®Šå¤„ç†

```
1. æˆ¿ä¸»ç‚¹å‡»"é€€å‡ºæˆ¿é—´"æŒ‰é’®
   â†“
2. å‰ç«¯æ£€æµ‹åˆ°å½“å‰ç”¨æˆ·æ˜¯æˆ¿ä¸»
   â†“
3. Toast æç¤ºï¼š"è¯·å…ˆè½¬è®©æˆ¿ä¸»åå†é€€å‡º"
   â†“
4. é˜»æ­¢é€€å‡ºæ“ä½œ
```

#### 3.5 çŠ¶æ€æµè½¬å›¾

```
æˆå‘˜çŠ¶æ€ï¼š
[åŠ å…¥æˆ¿é—´] â†’ [åœ¨æˆ¿ (status=0)]
              â†“
              â”œâ”€ [ä¸»åŠ¨ç¦»å¼€] â†’ [å·²ç¦»å¼€ (status=1, reason=leave)]
              â””â”€ [è¢«è¸¢å‡º] â†’ [å·²ç¦»å¼€ (status=1, reason=kick)]
```

---

### å››ã€ æ ¡éªŒä¸ä¸šåŠ¡è§„åˆ™ (Business Rules)

#### 4.1 æƒé™æ§åˆ¶

| æ“ä½œ | æˆ¿ä¸» | æ™®é€šæˆå‘˜ |
|------|------|----------|
| æŸ¥çœ‹æˆå‘˜åˆ—è¡¨ | âœ… | âœ… |
| è¸¢å‡ºå…¶ä»–æˆå‘˜ | âœ… | âŒ (æŒ‰é’®ä¸æ˜¾ç¤º) |
| è¸¢å‡ºè‡ªå·± | âŒ (æŒ‰é’®ä¸æ˜¾ç¤º) | - |
| ä¸»åŠ¨ç¦»å¼€æˆ¿é—´ | âŒ (éœ€è½¬è®©æˆ¿ä¸»åæ‰èƒ½ç¦»å¼€) | âœ… |
| è½¬è®©æˆ¿ä¸» | âœ… | âŒ |

**å‰ç«¯æ ¡éªŒé€»è¾‘ï¼š**
```typescript
// æ˜¯å¦æ˜¾ç¤ºè¸¢å‡ºæŒ‰é’®
const showKickButton = (member: GroupMember) => {
  const currentUser = getCurrentUser()
  return currentUser.role === 'owner' && member.userId !== currentUser.userId
}

// æˆ¿ä¸»ç¦»å¼€æˆ¿é—´å‰ç½®æ£€æŸ¥
const canLeaveGroup = () => {
  const currentUser = getCurrentUser()
  if (currentUser.role === 'owner') {
    Toast.show('è¯·å…ˆè½¬è®©æˆ¿ä¸»åå†é€€å‡º')
    return false
  }
  return true
}

// æ˜¯å¦æ˜¾ç¤º"é€€å‡ºæˆ¿é—´"æŒ‰é’®
const showLeaveButton = () => {
  const currentUser = getCurrentUser()
  return currentUser.role !== 'owner'
}
```

#### 4.2 è¡¨å•æ ¡éªŒ

æ— è¡¨å•è¾“å…¥ï¼Œä»…éœ€äºŒæ¬¡ç¡®è®¤å¼¹çª—ã€‚

#### 4.3 ä¸šåŠ¡è§„åˆ™

1. **æˆå‘˜ç¦»å¼€æˆ–è¢«è¸¢å**ï¼š
   - ä¸å†å‚ä¸åç»­ç»“ç®—
   - å†å²æ”¯å‡ºè®°å½•ä¿ç•™ï¼ˆä¸åˆ é™¤ï¼‰
   - ç»“ç®—é‡ç®—åŸºäºå½“å‰ç•™åœ¨æˆ¿é—´çš„æˆå‘˜

2. **WebSocket å¹¿æ’­é¡ºåº**ï¼š
   - å…ˆå¹¿æ’­ `member_leave` æˆ– `member_kick`
   - å†å¹¿æ’­ `settlement`ï¼ˆç»“ç®—æ›´æ–°ï¼‰
   - å‰ç«¯å…ˆæ›´æ–°æˆå‘˜åˆ—è¡¨ï¼Œå†åˆ·æ–°ç»“ç®—è§†å›¾

3. **æˆ¿é—´ä»…å‰© 1 äººæ—¶**ï¼š
   - ç»“ç®—åº”æ¸…ç©º transfers
   - netAmount = 0
   - å‰ç«¯æç¤º"æ— éœ€ç»“ç®—"

4. **æˆå‘˜ç¼“å­˜æ›´æ–°ç­–ç•¥**ï¼š
   - æ”¶åˆ° `member_kick` æˆ– `member_leave` åï¼Œä» `group_members` ç¼“å­˜ä¸­ç§»é™¤è¯¥æˆå‘˜
   - æˆ–æ ‡è®° `status=1`ï¼Œä¿ç•™å†å²è®°å½•

---

### äº”ã€ è¾¹ç¼˜åœºæ™¯ Checklist (Quality Assurance)

#### 5.1 UI è¾¹ç•Œæƒ…å†µ

- [ ] æˆå‘˜æ˜µç§°è¿‡é•¿æ—¶æˆªæ–­æ˜¾ç¤ºï¼ˆæœ€å¤š 10 å­—ç¬¦ + "..."ï¼‰
- [ ] æˆå‘˜åˆ—è¡¨ä¸ºç©ºæ—¶æ˜¾ç¤ºç©ºçŠ¶æ€ï¼š"æš‚æ— æˆå‘˜"
- [ ] è¸¢å‡ºæŒ‰é’® Loading çŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤ç‚¹å‡»ï¼‰
- [ ] ç¡®è®¤å¼¹çª—é®ç½©å±‚ç‚¹å‡»å…³é—­
- [ ] æˆå‘˜å¤´åƒåŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
- [ ] æˆ¿ä¸»æ ‡è¯†æ˜¾ç¤ºï¼ˆBadge æˆ–ç‰¹æ®Šå›¾æ ‡ï¼‰

#### 5.2 æ•°æ®ä¸€è‡´æ€§

- [ ] è¸¢å‡ºæˆå‘˜åï¼Œæœ¬åœ°ç¼“å­˜ `group_members` åŒæ­¥æ›´æ–°
- [ ] è¸¢å‡ºæˆå‘˜åï¼Œæµæ°´åˆ—è¡¨ä¸­è¯¥æˆå‘˜çš„è®°å½•ä¿ç•™ï¼ˆå†å²æ•°æ®ä¸åˆ é™¤ï¼‰
- [ ] WebSocket æ¶ˆæ¯å»é‡ï¼ˆé¿å…é‡å¤å¤„ç†åŒä¸€æ¡å¹¿æ’­ï¼‰
- [ ] è¢«è¸¢å‡ºåæ¸…é™¤æœ¬åœ°ç¼“å­˜ï¼Œé¿å…æ®‹ç•™æ•°æ®
- [ ] ç¦»å¼€æˆ¿é—´åï¼Œ`group_sessions` ä¸­ç§»é™¤è¯¥æˆ¿é—´è®°å½•

#### 5.3 ç½‘ç»œå¼‚å¸¸

- [ ] è¸¢å‡ºæ¥å£è¶…æ—¶ï¼ˆ10sï¼‰åæç¤ºç”¨æˆ·é‡è¯•
- [ ] ç¦»å¼€æ¥å£è¶…æ—¶åæç¤ºç”¨æˆ·é‡è¯•
- [ ] WebSocket æ–­çº¿æ—¶æ˜¾ç¤º"è¿æ¥å·²æ–­å¼€"æç¤º
- [ ] æ–­çº¿é‡è¿åè‡ªåŠ¨æ‹‰å–æœ€æ–°æˆå‘˜åˆ—è¡¨
- [ ] æ¥å£è¿”å› 403 æ—¶æç¤º"ä»…æˆ¿ä¸»å¯æ“ä½œ"
- [ ] æ¥å£è¿”å› 404 æ—¶æç¤º"æˆå‘˜ä¸å­˜åœ¨"
- [ ] æ¥å£è¿”å› 410 æ—¶æç¤º"æˆ¿é—´å·²è§£æ•£"ï¼Œè·³è½¬åˆ°åˆ—è¡¨é¡µ

#### 5.4 å¹¶å‘åœºæ™¯

- [ ] æˆ¿ä¸» A è¸¢å‡ºæˆå‘˜ B çš„åŒæ—¶ï¼Œæˆå‘˜ B ä¸»åŠ¨é€€å‡º â†’ ä»¥å…ˆåˆ°è¾¾çš„æ“ä½œä¸ºå‡†ï¼Œå‰ç«¯ä¿¡ä»»åç«¯çŠ¶æ€
- [ ] å¤šä¸ªæˆ¿ä¸»æ“ä½œï¼ˆè½¬è®©æˆ¿ä¸»åï¼‰â†’ åç«¯ä¿è¯åªæœ‰ä¸€ä¸ªæˆ¿ä¸»ï¼Œå‰ç«¯ä¿¡ä»»åç«¯çŠ¶æ€
- [ ] è¢«è¸¢ç”¨æˆ·æ­£åœ¨è®°è´¦ â†’ æ”¶åˆ° `member_kick` åï¼Œç¦æ­¢ç»§ç»­æäº¤å¹¶æç¤ºå·²è¢«ç§»å‡º
- [ ] æˆå‘˜ç¦»å¼€åä»æ”¶åˆ° WS â†’ å‰ç«¯è‹¥æ”¶åˆ°ä¸è‡ªèº« userId åŒ¹é…çš„ `member_leave`/`member_kick`ï¼Œéœ€æ–­å¼€ WS å¹¶æ¸…ç†æœ¬åœ°ç¼“å­˜

#### 5.5 å¼‚å¸¸åœºæ™¯å¤„ç†

| åœºæ™¯ | å‰ç«¯å¤„ç† |
|------|----------|
| éæˆ¿ä¸»å°è¯•è¸¢äºº | åç«¯è¿”å› 403ï¼ŒToast æç¤º"ä»…æˆ¿ä¸»å¯æ“ä½œ" |
| è¸¢å‡ºä¸å­˜åœ¨çš„æˆå‘˜ | åç«¯è¿”å› 404ï¼ŒToast æç¤º"æˆå‘˜ä¸å­˜åœ¨" |
| æˆ¿é—´å·²è§£æ•£ | åç«¯è¿”å› 410ï¼ŒToast æç¤º"æˆ¿é—´å·²è§£æ•£"ï¼Œè·³è½¬åˆ°åˆ—è¡¨é¡µ |
| ç½‘ç»œè¶…æ—¶ | Toast æç¤º"ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•" |
| WebSocket æ–­çº¿ | è‡ªåŠ¨é‡è¿ï¼ˆå¤ç”¨ `groupWs.ts` çš„é‡è¿æœºåˆ¶ï¼‰ |
| ç¦»å¼€/è¸¢å‡ºåç»“ç®—å¤±è´¥ | åç«¯è¿”å› errorï¼Œå‰ç«¯ä¿ç•™åŸç»“ç®—å¹¶æç¤º"ç»“ç®—æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" |
| æˆ¿é—´ä»…å‰© 1 äºº | ç»“ç®—æ¸…ç©º transfersï¼ŒnetAmount=0ï¼Œå‰ç«¯æç¤º"æ— éœ€ç»“ç®—" |

#### 5.6 å…¼å®¹æ€§

- [ ] å¾®ä¿¡å°ç¨‹åºç¯å¢ƒæµ‹è¯•ï¼ˆä¸»è¦ç›®æ ‡ï¼‰
- [ ] H5 ç¯å¢ƒæµ‹è¯•ï¼ˆWebSocket è¿æ¥ç¨³å®šæ€§ï¼‰
- [ ] æ”¯ä»˜å®å°ç¨‹åºç¯å¢ƒæµ‹è¯•ï¼ˆAPI å…¼å®¹æ€§ï¼‰
- [ ] ä¸åŒå±å¹•å°ºå¯¸ä¸‹çš„å¸ƒå±€é€‚é…

#### 5.7 æ€§èƒ½ä¼˜åŒ–

- [ ] æˆå‘˜åˆ—è¡¨æ¸²æŸ“æ€§èƒ½ï¼ˆ100+ æˆå‘˜ï¼‰
- [ ] WebSocket æ¶ˆæ¯å¤„ç†æ€§èƒ½ï¼ˆé«˜é¢‘å¹¿æ’­ï¼‰
- [ ] æœ¬åœ°ç¼“å­˜è¯»å†™æ€§èƒ½ï¼ˆå¤§é‡æµæ°´æ•°æ®ï¼‰

---

## ğŸ“‹ å®ç°æ¸…å• (Implementation Checklist)

### Phase 1: åç«¯æ¥å£å¯¹æ¥
- [ ] å®šä¹‰ TypeScript æ¥å£ç±»å‹ï¼ˆ`src/types/group.ts`ï¼‰
- [ ] åœ¨ `src/services/groupService.ts` ä¸­æ·»åŠ  `kickMember` æ–¹æ³•
- [ ] åœ¨ `src/services/groupService.ts` ä¸­æ·»åŠ  `leaveGroup` æ–¹æ³•
- [ ] æµ‹è¯•æ¥å£è°ƒç”¨ï¼ˆä½¿ç”¨ Postman æˆ–å¼€å‘å·¥å…·ï¼‰

### Phase 2: UI ç»„ä»¶å¼€å‘
- [ ] åœ¨æˆå‘˜åˆ—è¡¨ä¸­æ·»åŠ "è¸¢å‡º"æŒ‰é’®ï¼ˆä»…æˆ¿ä¸»å¯è§ï¼‰
- [ ] å®ç° `KickConfirmDialog` ç¡®è®¤å¼¹çª—
- [ ] å®ç° `LeaveConfirmDialog` ç¡®è®¤å¼¹çª—
- [ ] æ·»åŠ  Loading çŠ¶æ€å’Œé”™è¯¯æç¤º
- [ ] æ·»åŠ æˆ¿ä¸»æ ‡è¯† Badge
- [ ] ä¼˜åŒ–æˆå‘˜åˆ—è¡¨å¸ƒå±€å’Œæ ·å¼

### Phase 3: WebSocket é›†æˆ
- [ ] åœ¨ `src/services/groupWs.ts` ä¸­æ·»åŠ  `member_kick` äº‹ä»¶ç›‘å¬
- [ ] åœ¨ `src/services/groupWs.ts` ä¸­æ·»åŠ  `member_leave` äº‹ä»¶ç›‘å¬
- [ ] å®ç°æˆå‘˜åˆ—è¡¨å®æ—¶æ›´æ–°é€»è¾‘
- [ ] å®ç°ç»“ç®—è§†å›¾å®æ—¶æ›´æ–°é€»è¾‘
- [ ] è¢«è¸¢å‡ºç”¨æˆ·çš„è‡ªåŠ¨è·³è½¬é€»è¾‘
- [ ] ä¸»åŠ¨ç¦»å¼€ç”¨æˆ·çš„æ¸…ç†é€»è¾‘

### Phase 4: æœ¬åœ°ç¼“å­˜ç®¡ç†
- [ ] æ›´æ–° `group_members` ç¼“å­˜ï¼ˆç§»é™¤æˆå‘˜ï¼‰
- [ ] æ¸…ç† `group_transactions` ç¼“å­˜ï¼ˆè¢«è¸¢å‡º/ç¦»å¼€æ—¶ï¼‰
- [ ] æ¸…ç† `group_sessions` ç¼“å­˜ï¼ˆè¢«è¸¢å‡º/ç¦»å¼€æ—¶ï¼‰
- [ ] å®ç°ç¼“å­˜åŒæ­¥é€»è¾‘

### Phase 5: æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] å•å…ƒæµ‹è¯•ï¼šæƒé™æ ¡éªŒé€»è¾‘
- [ ] é›†æˆæµ‹è¯•ï¼šå®Œæ•´è¸¢å‡ºæµç¨‹
- [ ] é›†æˆæµ‹è¯•ï¼šå®Œæ•´ç¦»å¼€æµç¨‹
- [ ] è¾¹ç•Œæµ‹è¯•ï¼šç½‘ç»œå¼‚å¸¸ã€å¹¶å‘æ“ä½œ
- [ ] æ€§èƒ½æµ‹è¯•ï¼šæˆå‘˜åˆ—è¡¨æ¸²æŸ“æ€§èƒ½ï¼ˆ100+ æˆå‘˜ï¼‰
- [ ] å…¼å®¹æ€§æµ‹è¯•ï¼šå¾®ä¿¡å°ç¨‹åºã€H5ã€æ”¯ä»˜å®å°ç¨‹åº

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `src/pages/group/index.tsx` - æˆ¿é—´ä¸»é¡µé¢
- `src/services/groupService.ts` - æˆ¿é—´ç›¸å…³æ¥å£
- `src/services/groupWs.ts` - WebSocket è¿æ¥ç®¡ç†
- `src/services/storage.ts` - æœ¬åœ°ç¼“å­˜ç®¡ç†
- `src/types/group.ts` - æˆ¿é—´ç›¸å…³ç±»å‹å®šä¹‰
- `src/components/ui/` - å¯å¤ç”¨çš„ UI ç»„ä»¶

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æƒé™æ ¡éªŒåŒé‡ä¿éšœ**ï¼šå‰ç«¯éšè—æŒ‰é’® + åç«¯æ¥å£é‰´æƒ
2. **WebSocket æ¶ˆæ¯å¹‚ç­‰æ€§**ï¼šä½¿ç”¨ `timestamp` æˆ– `messageId` å»é‡
3. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šæ“ä½œåé¦ˆåŠæ—¶ï¼ˆToast + åˆ—è¡¨æ›´æ–°ï¼‰
4. **æ•°æ®ä¸€è‡´æ€§**ï¼šè¢«è¸¢å‡ºåæ¸…é™¤ç¼“å­˜ï¼Œé¿å…è„æ•°æ®
5. **éµå¾ªç°æœ‰è§„èŒƒ**ï¼š
   - å¤ç”¨ `groupWs.ts` çš„ WebSocket ç®¡ç†é€»è¾‘
   - ä¿æŒä»£ç é£æ ¼ä¸€è‡´ï¼ˆ2 ç©ºæ ¼ã€å•å¼•å·ã€æ— åˆ†å·ï¼‰
   - ä½¿ç”¨ Taroify ç»„ä»¶åº“ï¼ˆ`@taroify/core`ï¼‰
   - SCSS æ ·å¼ï¼Œ2 ç©ºæ ¼ç¼©è¿›
6. **å†å²æ•°æ®ä¿ç•™**ï¼šæˆå‘˜ç¦»å¼€åï¼Œå†å²æµæ°´è®°å½•ä¸åˆ é™¤ï¼Œä»…æ ‡è®°çŠ¶æ€
7. **æˆ¿ä¸»è½¬è®©**ï¼šæˆ¿ä¸»ç¦»å¼€å‰å¿…é¡»å…ˆè½¬è®©æˆ¿ä¸»æƒé™ï¼ˆæœ¬éœ€æ±‚ä¸åŒ…å«è½¬è®©åŠŸèƒ½ï¼Œéœ€å•ç‹¬å®ç°ï¼‰
8. **ç»“ç®—æ›´æ–°**ï¼šæˆå‘˜å˜åŠ¨åï¼Œåç«¯ä¼šé‡æ–°è®¡ç®—ç»“ç®—ï¼Œå‰ç«¯éœ€ç›‘å¬ `settlement` å¹¿æ’­å¹¶æ›´æ–°è§†å›¾

---

## ğŸ¯ æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹

### 1. WebSocket æ¶ˆæ¯å¤„ç†æµç¨‹

```typescript
// src/services/groupWs.ts
export const handleMemberChange = (message: MemberChangeMessage) => {
  const { type, groupId, userId, operatorId } = message
  const currentUserId = getCurrentUserId()

  if (type === 'member_kick' || type === 'member_leave') {
    // æ›´æ–°æˆå‘˜ç¼“å­˜
    updateMemberCache(groupId, userId, 'remove')

    // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·è¢«è¸¢å‡ºæˆ–ç¦»å¼€
    if (userId === currentUserId) {
      // æ–­å¼€ WebSocket
      disconnectWebSocket(groupId)
      // æ¸…ç†æœ¬åœ°ç¼“å­˜
      clearGroupCache(groupId)
      // è·³è½¬åˆ°åˆ—è¡¨é¡µ
      Taro.redirectTo({ url: '/pages/groupList/index' })
      // æç¤º
      Toast.show(type === 'member_kick' ? 'æ‚¨å·²è¢«ç§»å‡ºæˆ¿é—´' : 'å·²é€€å‡ºæˆ¿é—´')
    } else {
      // æç¤ºå…¶ä»–æˆå‘˜
      const member = getMemberFromCache(groupId, userId)
      Toast.show(`${member?.nickname || 'æˆå‘˜'} ${type === 'member_kick' ? 'å·²è¢«ç§»å‡ºæˆ¿é—´' : 'å·²ç¦»å¼€æˆ¿é—´'}`)
    }
  }
}
```

### 2. æƒé™æ§åˆ¶å®ç°

```typescript
// src/pages/group/index.tsx
const MemberItem = ({ member }: { member: GroupMember }) => {
  const currentUser = useCurrentUser()
  const isOwner = currentUser.role === 'owner'
  const isSelf = member.userId === currentUser.userId

  return (
    <View className="member-item">
      <Image src={member.avatar} className="avatar" />
      <Text className="nickname">{member.nickname}</Text>
      {member.role === 'owner' && <Badge>æˆ¿ä¸»</Badge>}
      {isOwner && !isSelf && (
        <Button size="small" onClick={() => handleKick(member)}>
          è¸¢å‡º
        </Button>
      )}
    </View>
  )
}
```

### 3. æœ¬åœ°ç¼“å­˜ç®¡ç†

```typescript
// src/services/storage.ts
export const clearGroupCache = (groupId: string) => {
  // æ¸…é™¤æˆå‘˜ç¼“å­˜
  const members = Taro.getStorageSync('group_members') || {}
  delete members[groupId]
  Taro.setStorageSync('group_members', members)

  // æ¸…é™¤æµæ°´ç¼“å­˜
  const transactions = Taro.getStorageSync('group_transactions') || {}
  delete transactions[groupId]
  Taro.setStorageSync('group_transactions', transactions)

  // æ¸…é™¤æˆ¿é—´ä¼šè¯
  const sessions = Taro.getStorageSync('group_sessions') || []
  const newSessions = sessions.filter(s => s.groupId !== groupId)
  Taro.setStorageSync('group_sessions', newSessions)
}
```

---

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

1. **æˆ¿ä¸»è½¬è®©åŠŸèƒ½**ï¼šå…è®¸æˆ¿ä¸»å°†æƒé™è½¬è®©ç»™å…¶ä»–æˆå‘˜åå†ç¦»å¼€
2. **æˆå‘˜æƒé™ç®¡ç†**ï¼šæ”¯æŒå¤šçº§æƒé™ï¼ˆç®¡ç†å‘˜ã€æ™®é€šæˆå‘˜ç­‰ï¼‰
3. **ç¦»å¼€åŸå› è®°å½•**ï¼šåœ¨æˆå‘˜åˆ—è¡¨ä¸­æ˜¾ç¤ºç¦»å¼€åŸå› å’Œæ—¶é—´
4. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡è¸¢å‡ºæˆå‘˜
5. **é»‘åå•åŠŸèƒ½**ï¼šè¢«è¸¢å‡ºçš„æˆå‘˜æ— æ³•å†æ¬¡åŠ å…¥
6. **æ“ä½œæ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æˆå‘˜å˜åŠ¨æ“ä½œï¼Œä¾¿äºè¿½æº¯
